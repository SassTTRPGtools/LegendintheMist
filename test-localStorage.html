<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>localStorage åŠŸèƒ½æ¸¬è©¦</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a2e;
            color: #eee;
        }
        .container {
            background: #16213e;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        h1, h2 {
            color: #a855f7;
        }
        button {
            background: #a855f7;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #9333ea;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success { background: #059669; }
        .error { background: #dc2626; }
        .info { background: #0284c7; }
        .warning { background: #d97706; }
        textarea {
            width: 100%;
            height: 200px;
            background: #1e293b;
            color: #eee;
            border: 1px solid #475569;
            border-radius: 5px;
            padding: 10px;
            font-family: monospace;
        }
        .data-info {
            background: #1e293b;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #a855f7;
        }
    </style>
</head>
<body>
    <h1>è§’è‰²å»ºç«‹å™¨ localStorage åŠŸèƒ½æ¸¬è©¦</h1>
    
    <div class="container">
        <h2>å­˜å„²ç‹€æ…‹æª¢æŸ¥</h2>
        <button onclick="checkStorageStatus()">æª¢æŸ¥å­˜å„²ç‹€æ…‹</button>
        <button onclick="showStorageSize()">é¡¯ç¤ºå­˜å„²å¤§å°</button>
        <div id="storageStatus"></div>
    </div>

    <div class="container">
        <h2>æ¸¬è©¦æ•¸æ“šæ“ä½œ</h2>
        <button onclick="createTestData()">å‰µå»ºæ¸¬è©¦æ•¸æ“š</button>
        <button onclick="saveTestData()">ä¿å­˜æ¸¬è©¦æ•¸æ“š</button>
        <button onclick="loadTestData()">è¼‰å…¥æ¸¬è©¦æ•¸æ“š</button>
        <button onclick="clearTestData()">æ¸…é™¤æ¸¬è©¦æ•¸æ“š</button>
        <div id="testDataStatus"></div>
    </div>

    <div class="container">
        <h2>å­˜å„²å…§å®¹æŸ¥çœ‹</h2>
        <button onclick="viewStorageContent()">æŸ¥çœ‹å­˜å„²å…§å®¹</button>
        <button onclick="exportStorageData()">åŒ¯å‡ºå­˜å„²æ•¸æ“š</button>
        <textarea id="storageContent" placeholder="å­˜å„²å…§å®¹å°‡é¡¯ç¤ºåœ¨é€™è£¡..."></textarea>
    </div>

    <div class="container">
        <h2>ç€è¦½å™¨å…¼å®¹æ€§æ¸¬è©¦</h2>
        <button onclick="testBrowserSupport()">æ¸¬è©¦ç€è¦½å™¨æ”¯æ´</button>
        <button onclick="testStorageQuota()">æ¸¬è©¦å­˜å„²é…é¡</button>
        <div id="browserStatus"></div>
    </div>

    <script>
        const STORAGE_KEY = 'mo-character-builder-data';
        
        // é¡¯ç¤ºç‹€æ…‹ä¿¡æ¯
        function showStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        // æª¢æŸ¥å­˜å„²ç‹€æ…‹
        function checkStorageStatus() {
            try {
                const hasData = localStorage.getItem(STORAGE_KEY) !== null;
                const timestamp = hasData ? JSON.parse(localStorage.getItem(STORAGE_KEY)).timestamp : null;
                
                let message = hasData 
                    ? `âœ… æ‰¾åˆ°ä¿å­˜çš„è§’è‰²è³‡æ–™<br>ä¿å­˜æ™‚é–“: ${new Date(timestamp).toLocaleString()}`
                    : 'âŒ æ²’æœ‰æ‰¾åˆ°ä¿å­˜çš„è§’è‰²è³‡æ–™';
                
                showStatus('storageStatus', message, hasData ? 'success' : 'warning');
            } catch (error) {
                showStatus('storageStatus', `âŒ æª¢æŸ¥å¤±æ•—: ${error.message}`, 'error');
            }
        }

        // é¡¯ç¤ºå­˜å„²å¤§å°
        function showStorageSize() {
            try {
                const data = localStorage.getItem(STORAGE_KEY);
                if (data) {
                    const sizeInBytes = new Blob([data]).size;
                    const sizeInKB = (sizeInBytes / 1024).toFixed(2);
                    showStatus('storageStatus', `ğŸ“Š å­˜å„²å¤§å°: ${sizeInKB} KB (${sizeInBytes} bytes)`, 'info');
                } else {
                    showStatus('storageStatus', 'ğŸ“Š æ²’æœ‰è³‡æ–™å¯ä»¥è¨ˆç®—å¤§å°', 'warning');
                }
            } catch (error) {
                showStatus('storageStatus', `âŒ è¨ˆç®—å¤§å°å¤±æ•—: ${error.message}`, 'error');
            }
        }

        // å‰µå»ºæ¸¬è©¦æ•¸æ“š
        function createTestData() {
            const testData = {
                version: '1.0',
                timestamp: new Date().toISOString(),
                character: {
                    name: 'æ¸¬è©¦è§’è‰²',
                    background: 'æ¸¬è©¦èƒŒæ™¯',
                    evolutionTrack: [true, false, false, false, false],
                    evolutionHistory: [],
                    veteranSpecialties: [],
                    levelUpGameImprovements: [],
                    equipment: {
                        name: 'æ¸¬è©¦è£å‚™',
                        improvements: Array(3).fill().map(() => ({ checked: false })),
                        power: 1,
                        abilities: Array(7).fill().map(() => ({ text: '', isBurned: false })),
                        weaknesses: Array(2).fill().map(() => ({ text: '' })),
                        specialties: [],
                        isEditing: false
                    },
                    teamThemeCard: {
                        title: 'æ¸¬è©¦åœ˜éšŠä¸»é¡Œ',
                        abilities: Array(7).fill().map(() => ({ text: '', isBurned: false })),
                        weaknesses: Array(2).fill().map(() => ({ text: '' })),
                        customSpecialties: [],
                        improvements: Array(3).fill().map(() => ({ checked: false })),
                        decays: Array(3).fill().map(() => ({ checked: false })),
                        isEditing: false
                    },
                    themeCards: Array(4).fill().map((_, index) => ({
                        selectedThemeType: 'mythos',
                        selectedTheme: 'test',
                        title: `æ¸¬è©¦ä¸»é¡Œå¡ ${index + 1}`,
                        abilities: Array(7).fill().map(() => ({ text: '', isBurned: false })),
                        weaknesses: Array(2).fill().map(() => ({ text: '' })),
                        improvements: Array(3).fill().map(() => ({ checked: false })),
                        decays: Array(3).fill().map(() => ({ checked: false })),
                        selectedSpecialty: '',
                        selectedSpecialties: [],
                        motivation: {
                            identity: '',
                            ritual: '',
                            itch: ''
                        },
                        isEditing: false
                    }))
                },
                showHowToPlay: false
            };
            
            window.testData = testData;
            showStatus('testDataStatus', 'âœ… æ¸¬è©¦æ•¸æ“šå·²å‰µå»º', 'success');
        }

        // ä¿å­˜æ¸¬è©¦æ•¸æ“š
        function saveTestData() {
            try {
                if (!window.testData) {
                    showStatus('testDataStatus', 'âŒ è«‹å…ˆå‰µå»ºæ¸¬è©¦æ•¸æ“š', 'warning');
                    return;
                }
                
                localStorage.setItem(STORAGE_KEY, JSON.stringify(window.testData));
                showStatus('testDataStatus', 'âœ… æ¸¬è©¦æ•¸æ“šå·²ä¿å­˜åˆ° localStorage', 'success');
            } catch (error) {
                showStatus('testDataStatus', `âŒ ä¿å­˜å¤±æ•—: ${error.message}`, 'error');
            }
        }

        // è¼‰å…¥æ¸¬è©¦æ•¸æ“š
        function loadTestData() {
            try {
                const data = localStorage.getItem(STORAGE_KEY);
                if (data) {
                    const parsed = JSON.parse(data);
                    showStatus('testDataStatus', `âœ… æ•¸æ“šè¼‰å…¥æˆåŠŸ<br>è§’è‰²åç¨±: ${parsed.character?.name || 'æœªçŸ¥'}<br>ä¿å­˜æ™‚é–“: ${new Date(parsed.timestamp).toLocaleString()}`, 'success');
                } else {
                    showStatus('testDataStatus', 'âŒ æ²’æœ‰æ‰¾åˆ°ä¿å­˜çš„æ•¸æ“š', 'warning');
                }
            } catch (error) {
                showStatus('testDataStatus', `âŒ è¼‰å…¥å¤±æ•—: ${error.message}`, 'error');
            }
        }

        // æ¸…é™¤æ¸¬è©¦æ•¸æ“š
        function clearTestData() {
            try {
                localStorage.removeItem(STORAGE_KEY);
                showStatus('testDataStatus', 'âœ… æ¸¬è©¦æ•¸æ“šå·²æ¸…é™¤', 'success');
            } catch (error) {
                showStatus('testDataStatus', `âŒ æ¸…é™¤å¤±æ•—: ${error.message}`, 'error');
            }
        }

        // æŸ¥çœ‹å­˜å„²å…§å®¹
        function viewStorageContent() {
            try {
                const data = localStorage.getItem(STORAGE_KEY);
                const contentTextarea = document.getElementById('storageContent');
                
                if (data) {
                    // ç¾åŒ– JSON æ ¼å¼
                    const parsed = JSON.parse(data);
                    contentTextarea.value = JSON.stringify(parsed, null, 2);
                } else {
                    contentTextarea.value = 'æ²’æœ‰æ‰¾åˆ°ä¿å­˜çš„æ•¸æ“š';
                }
            } catch (error) {
                document.getElementById('storageContent').value = `éŒ¯èª¤: ${error.message}`;
            }
        }

        // åŒ¯å‡ºå­˜å„²æ•¸æ“š
        function exportStorageData() {
            try {
                const data = localStorage.getItem(STORAGE_KEY);
                if (data) {
                    const blob = new Blob([data], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `character-builder-storage-${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                    
                    showStatus('storageStatus', 'âœ… å­˜å„²æ•¸æ“šå·²åŒ¯å‡º', 'success');
                } else {
                    showStatus('storageStatus', 'âŒ æ²’æœ‰æ•¸æ“šå¯ä»¥åŒ¯å‡º', 'warning');
                }
            } catch (error) {
                showStatus('storageStatus', `âŒ åŒ¯å‡ºå¤±æ•—: ${error.message}`, 'error');
            }
        }

        // æ¸¬è©¦ç€è¦½å™¨æ”¯æ´
        function testBrowserSupport() {
            let message = '';
            
            // localStorage æ”¯æ´æª¢æ¸¬
            if (typeof(Storage) !== "undefined") {
                message += 'âœ… ç€è¦½å™¨æ”¯æ´ localStorage<br>';
            } else {
                message += 'âŒ ç€è¦½å™¨ä¸æ”¯æ´ localStorage<br>';
            }
            
            // å¯ç”¨æ€§æ¸¬è©¦
            try {
                localStorage.setItem('test', 'test');
                localStorage.removeItem('test');
                message += 'âœ… localStorage å¯æ­£å¸¸è®€å¯«<br>';
            } catch (error) {
                message += `âŒ localStorage è®€å¯«å¤±æ•—: ${error.message}<br>`;
            }
            
            // JSON æ”¯æ´æª¢æ¸¬
            try {
                JSON.parse('{"test": true}');
                JSON.stringify({"test": true});
                message += 'âœ… JSON åºåˆ—åŒ–æ”¯æ´æ­£å¸¸<br>';
            } catch (error) {
                message += `âŒ JSON åºåˆ—åŒ–å¤±æ•—: ${error.message}<br>`;
            }
            
            showStatus('browserStatus', message, 'info');
        }

        // æ¸¬è©¦å­˜å„²é…é¡
        function testStorageQuota() {
            try {
                // ç°¡å–®çš„é…é¡æ¸¬è©¦
                let testData = 'x';
                let size = 0;
                
                // æ¸¬è©¦å¤§æ¦‚çš„å­˜å„²é™åˆ¶ï¼ˆä¸æœƒçœŸçš„å¡«æ»¿ï¼‰
                try {
                    for (let i = 0; i < 1000; i++) {
                        testData += 'x'.repeat(1000); // æ¯æ¬¡å¢åŠ  1KB
                        localStorage.setItem('quota-test', testData);
                        size = testData.length;
                    }
                } catch (error) {
                    // é‡åˆ°é…é¡é™åˆ¶æˆ–å…¶ä»–éŒ¯èª¤
                    showStatus('browserStatus', `ğŸ“Š å¤§æ¦‚å­˜å„²é™åˆ¶æ¸¬è©¦å®Œæˆ<br>æ¸¬è©¦åˆ° ${(size / 1024).toFixed(0)} KB å·¦å³é‡åˆ°é™åˆ¶<br>éŒ¯èª¤: ${error.message}`, 'warning');
                } finally {
                    // æ¸…ç†æ¸¬è©¦æ•¸æ“š
                    localStorage.removeItem('quota-test');
                }
                
                if (size === 0) {
                    showStatus('browserStatus', 'âŒ ç„¡æ³•é€²è¡Œé…é¡æ¸¬è©¦', 'error');
                }
            } catch (error) {
                showStatus('browserStatus', `âŒ é…é¡æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
            }
        }

        // é é¢è¼‰å…¥æ™‚è‡ªå‹•æª¢æŸ¥
        window.addEventListener('load', function() {
            checkStorageStatus();
            testBrowserSupport();
        });
    </script>
</body>
</html>
